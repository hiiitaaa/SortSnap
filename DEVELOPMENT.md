# SortSnap 開発経過記録

## プロジェクト概要

画像ファイルを視覚的に並べ替え、統一された命名規則で一括リネーム・保存するクロスプラットフォーム対応のGUIツール

## 開発環境

- **言語**: Python 3.10+
- **GUIフレームワーク**: PyQt6 6.6.1
- **画像処理**: Pillow 10.2.0
- **パッケージング**: PyInstaller 6.3.0
- **アーキテクチャ**: MVC (Model-View-Controller)

## 開発履歴

### 2025-10-07 (7): 非同期読み込み・UI/UX改善・バグ修正（Phase 6）

#### 実装内容

**非同期読み込み、キーボードショートカット、バグ修正など総合的な改善**

1. **非同期画像読み込み（LoadWorker）**
   - 初回フォルダ読み込みを非同期化（QThread使用）
   - プログレスバーで進捗表示（枚数、ファイル名、残り時間）
   - サムネイルを事前生成し後続操作を高速化
   - フォルダモード・ファイルモード両対応
   - `src/controllers/load_worker.py`（新規作成）
   - `src/views/main_window.py:384-471`

2. **サムネイルサイズ変更の超高速化**
   - Pillowでの再生成を廃止 → QPixmap.scaled()でQt側のみでリサイズ
   - ほぼ瞬時にサイズ変更可能（0.1秒以下）
   - グリッド列数の自動再計算で表示領域に収まる
   - `src/views/preview_area.py:185-208`

3. **キーボードショートカット追加**
   - Alt+↑: サムネイル拡大
   - Alt+↓: サムネイル縮小
   - Alt+ホイール: サムネイルサイズ変更
   - MainWindowレベルで実装（フォーカスに依存しない）
   - `src/views/main_window.py:123-135, 523-539`

4. **プログレスダイアログにアニメーション**
   - idle.gif（100x100、背景透過）を表示
   - 「画像を読み込んでいます...」メッセージの横に配置
   - QMovieで1.5倍速再生
   - ユーザーを退屈させない工夫
   - `src/views/progress_dialog.py:119-153`
   - `animations/idle.gif`（新規追加）

5. **リセット機能**
   - 読み込んだ画像を全てクリア
   - 確認ダイアログ付き（「この操作は取り消せません」）
   - Undo履歴もクリア
   - 初期状態（プレースホルダー表示）に戻す
   - `src/views/settings_panel.py:262-284, 354-356`
   - `src/views/main_window.py:319-343`

6. **リネーム機能のバグ修正**
   - 問題：拡張子が欠落（`001.jpg` → `sequential`）
   - 原因：`image.get_new_filename()`が単純な文字列置換のみ
   - 解決：`RenameController.generate_filename()`を使用
   - 元ファイルの拡張子を正しく付与
   - `src/controllers/file_controller.py:15, 56-70`

7. **サンプル表示の改善**
   - 問題：サンプル表示が空白
   - 解決：デフォルト値設定、初期化時に更新、文字色明示
   - 常に1行のサンプルを表示（例: `001.jpg`）
   - リアルタイム更新対応
   - `src/views/settings_panel.py:187-191, 370-386`

8. **新規フォルダ作成の改善**
   - フォルダ名重複時に自動で `_1`, `_2`... を付与
   - ユーザーに確認ダイアログを表示せず自動処理
   - 最大1000まで試行（無限ループ防止）
   - `src/controllers/file_controller.py:114-155`

#### パフォーマンス改善効果

**初回読み込み**：
- 変更前：5-6秒（同期処理、UIフリーズ）
- 変更後：2-3秒（非同期、プログレスバー表示、UIフリーズなし）

**サムネイルサイズ変更**：
- 変更前：2-3秒（Pillow再生成）
- 変更後：0.1秒以下（Qt側のみでリサイズ）

#### 修正ファイル
- `src/controllers/load_worker.py`（新規）
- `src/controllers/file_controller.py`
- `src/views/main_window.py`
- `src/views/preview_area.py`
- `src/views/progress_dialog.py`
- `src/views/settings_panel.py`
- `animations/idle.gif`（新規）

#### ステータス

✅ **Phase 6完了 - 非同期処理・UI/UX大幅改善！**

読み込みが高速化され、キーボードショートカットで操作性向上、バグも修正され実用性が大幅に向上しました。

### 2025-10-07 (6): サムネイル高速化・パフォーマンス改善（Phase 5）

#### 実装内容

**サムネイル表示のパフォーマンスを劇的に改善**

1. **サムネイルサイズ変更の実装**
   - 問題：拡大/縮小ボタンでサムネイル画像自体のサイズが変わらなかった
   - 解決：ThumbnailWidgetにサイズパラメータを渡し、サムネイルを再生成
   - 虫眼鏡ボタンの位置も自動調整
   - `src/views/preview_area.py:115-119, 276-282, 361-366, 432-444`

2. **サムネイルキャッシュ機構**
   - サイズごとにサムネイルをメモリキャッシュ
   - 同じサイズに戻した場合は再生成不要（瞬時に表示）
   - `dict[int, QPixmap]` でサイズをキーにキャッシュ
   - `src/models/image_model.py:21-22, 50-53, 77-78, 110-124`

3. **高速リサンプリング**
   - `LANCZOS` → `BILINEAR` に変更
   - 約2-3倍高速化、品質は実用上問題なし
   - `src/models/image_model.py:70`

4. **ウィジェット再利用機構** 🚀
   - 問題：サイズ変更時に500個のウィジェットを破棄→再作成（5-6秒）
   - 解決：既存ウィジェットを再利用し、画像部分のみ更新
   - 2回目以降のサイズ変更が **0.1秒以下（ほぼ瞬時）** に
   - `src/views/preview_area.py:163-187, 432-444`

#### パフォーマンス改善効果

**変更前**：
- 初回読み込み：5-6秒
- サイズ変更：毎回5-6秒（ウィジェット再作成）

**変更後**：
- 初回読み込み：2-3秒（BILINEAR効果）
- 2回目以降のサイズ変更：**0.1秒以下**（ウィジェット再利用 + キャッシュ）
- 同サイズに戻す：**ほぼ瞬時**（キャッシュから取得）

#### 技術的詳細

**ウィジェット再利用の仕組み**
```python
# 従来：毎回全削除→再作成
def update_thumbnail_size(self, size):
    self.load_images(self.images)  # 500個破棄→500個作成

# 改善後：既存を更新
def update_thumbnail_size(self, size):
    if self.thumbnail_widgets:
        self._update_existing_thumbnails(size)  # 更新のみ
    else:
        self.load_images(self.images)  # 初回のみ
```

**キャッシュの仕組み**
```python
# サイズごとにQPixmapをキャッシュ
_thumbnail_cache: dict[int, QPixmap] = {
    200: <QPixmap>,  # 200pxサイズ
    250: <QPixmap>,  # 250pxサイズ
    150: <QPixmap>,  # 150pxサイズ
}
```

#### 修正ファイル
- `src/models/image_model.py`: キャッシュ機構、高速リサンプリング
- `src/views/preview_area.py`: ウィジェット再利用、サイズ変更対応

#### ステータス

✅ **Phase 5完了 - パフォーマンス大幅改善！**

大量画像（500枚）でも快適に操作できるようになりました。

#### 今後の改善案（未実装）

**さらなる高速化**：
1. **非同期読み込み（QThread）**
   - 初回読み込みも高速化
   - プログレスバー表示
2. **遅延読み込み（Lazy Loading）**
   - 表示範囲のサムネイルのみ生成
   - スクロール時に追加生成
3. **ディスクキャッシュ**
   - `.cache/` フォルダに保存
   - アプリ再起動後も高速

### 2025-10-07 (5): 角括弧対応・UI/UX改善（Phase 4）

#### 実装内容

**特殊文字を含むパスへの対応とユーザー体験の大幅改善**

1. **角括弧を含むパスの対応**
   - 問題：`[4K500P]` などの角括弧がパス名にあるとglob.glob()が失敗
   - 解決：`glob.glob()` → `Path.iterdir()` に変更
   - 確実なファイル検索を実現
   - `src/controllers/image_controller.py:18-74`

2. **エラーハンドリングの強化**
   - フォルダ読み込み時の例外を明確化
   - `FileNotFoundError`、`NotADirectoryError`、`PermissionError` を個別処理
   - ユーザーに分かりやすいエラーメッセージ表示
   - 対応形式も表示して親切に
   - `src/views/main_window.py:380-439`

3. **虫眼鏡ボタンによるプレビュー表示**
   - サムネイル右下に実体のある `QPushButton` を配置
   - 絵文字🔍で視認性向上
   - ホバー時（500ms待機）で自動プレビュー表示
   - クリックで即座にプレビュー表示
   - ホバー時は青色ハイライト
   - `src/views/preview_area.py:296-368`

4. **ダブルクリック対応**
   - サムネイル本体のダブルクリックでプレビュー表示
   - シングルクリックは選択専用に変更
   - タイマーベースのダブルクリック検出
   - `src/views/preview_area.py:284-289, 428-449`

5. **選択状態の視覚フィードバック強化**
   - 選択時：画像に **5px の太い青枠**（`#2196F3`）
   - 背景全体が薄い青色（`#E3F2FD`）
   - 非選択時：2px のグレー枠（`#E0E0E0`）
   - ホバー時：薄いグレー背景（`#F5F5F5`）
   - 画像自体に枠を表示することで視認性大幅向上
   - `src/views/preview_area.py:370-403`

6. **プレビューダイアログに閉じるボタン追加**
   - 削除ボタンの右隣に配置
   - 青色の目立つデザイン（`#1976D2`）
   - `Esc` キーと併用可能
   - `src/views/preview_dialog.py:109-121`

#### 修正ファイル
- `src/controllers/image_controller.py`: glob → iterdir、例外処理強化
- `src/views/main_window.py`: エラーメッセージ改善
- `src/views/preview_area.py`: 虫眼鏡ボタン、ダブルクリック、選択表示
- `src/views/preview_dialog.py`: 閉じるボタン追加

#### 技術的改善

**glob.glob() の問題点と解決**
- 角括弧 `[` `]` は glob のワイルドカード文字（文字クラス）
- `[4K500P]` → `4`, `K`, `5`, `0`, `P` のいずれか1文字にマッチ
- `glob.escape()` でエスケープ可能だが、`Path.iterdir()` の方が確実
- 拡張子判定は `.suffix.lower()` で大文字小文字を統一

**UI/UXの設計判断**
- paintEvent でのアイコン描画は不確実 → 実体ウィジェット（QPushButton）に
- クリック操作の整理：
  - シングルクリック → 選択
  - ダブルクリック → プレビュー
  - 虫眼鏡クリック → プレビュー
  - 虫眼鏡ホバー（500ms） → プレビュー
  - ドラッグ → 並べ替え

#### ステータス

✅ **Phase 4完了 - 実用性・安定性が向上！**

角括弧などの特殊文字を含むパスでも正常動作し、ユーザー体験が大幅に改善されました。

### 2025-10-06 (4): 全機能実装完了（Phase 3 - 最終版）

#### 実装内容

**残りの全機能を実装し、アプリケーションが完全に動作する状態に**

1. **新規フォルダ作成モード**
   - 画像ファイルのドラッグ&ドロップ受付
   - 自動的に新規フォルダ作成モードに切り替え
   - フォルダ名の指定（デフォルト: 今日の日付YYMMDD）
   - 重複チェック・エラーハンドリング
   - ログ記録

2. **非同期保存処理**
   - QThreadを使った非同期処理
   - SaveWorkerクラスによるバックグラウンド保存
   - プログレスバーとの完全連携
   - キャンセル機能の実装
   - UIのフリーズ防止

3. **スプラッシュスクリーン**
   - 起動時のMP4アニメーション再生
   - 初期化進捗の表示
   - プログレスバー付き
   - アプリ名・バージョン表示
   - 美しいデザイン

4. **ファイル/フォルダドロップ対応**
   - メインウィンドウへのドラッグ&ドロップ
   - フォルダドロップ → フォルダモードで読み込み
   - ファイルドロップ → 新規フォルダ作成モード
   - 自動的なモード切替

#### 新規ファイル
- `src/controllers/save_worker.py`: 非同期保存ワーカー
- `src/views/splash_screen.py`: スプラッシュスクリーン
- `main.py`: スプラッシュスクリーン対応に更新

#### 完成した機能一覧

✅ **完全実装済み（全機能動作）**
- フォルダから画像読み込み
- ファイル/フォルダのドラッグ&ドロップ
- サムネイル表示・サイズ調整
- ドラッグ&ドロップ並べ替え
- 複数選択（Ctrl, Shift, Ctrl+A）
- 画像削除（Delete, Space）
- ソート（ファイル名順、元の順序）
- Undo/Redo（最大50段階）
- 画像拡大表示（プレビューダイアログ）
- ズーム機能
- リネーム（3種類のテンプレート）
- PNG→JPG変換
- 非同期保存処理
- プログレスバー（進捗・残り時間・キャンセル）
- 新規フォルダ作成モード
- スプラッシュスクリーン
- 設定の永続化
- ログ機能
- MP4アニメーション再生

#### ステータス

🎉 **Phase 3完了 - 全機能実装完了！**

アプリケーションは完全に動作可能な状態です。要件定義書の全ての機能が実装され、実用レベルに達しています。

### 2025-10-06 (3): 主要機能実装完了（Phase 2）

#### 実装内容

**Phase 2として、ユーザー操作に関わる重要な機能を全て実装**

1. **ドラッグ&ドロップによる並べ替え**
   - マウスドラッグで画像の順序を直感的に変更
   - ドラッグ中のプレビュー画像表示
   - ドロップ位置の視覚的フィードバック
   - Undo/Redo完全対応

2. **複数選択機能**
   - Ctrl+クリック: トグル選択（個別に追加/削除）
   - Shift+クリック: 範囲選択
   - Ctrl+A: 全選択
   - Ctrl+D / Esc: 選択解除
   - 選択状態の視覚的フィードバック（青枠 + 背景色）

3. **画像削除機能**
   - Delete / Space: 選択画像を削除
   - 削除確認ダイアログ
   - Undo/Redo完全対応
   - ログ記録

4. **プレビューダイアログ（画像拡大表示）**
   - 画像クリックで拡大表示
   - ズーム機能
     - 拡大/縮小ボタン
     - 100%表示
     - ウィンドウサイズに合わせる
     - ホイールズーム対応
   - 矢印キーで前後の画像へ移動
   - プレビュー画面からの削除機能
   - 画像情報表示（ファイル名、解像度、サイズ、番号）

5. **プログレスバー付き保存処理**
   - 保存中の進捗をリアルタイム表示
   - 処理枚数（現在/全体）
   - 進捗率（%）
   - 経過時間・残り時間の表示
   - 現在処理中のファイル名表示
   - キャンセル機能（確認ダイアログ付き）
   - 完了時の自動クローズ

#### 技術的な改善

**PreviewArea（src/views/preview_area.py）**
- 完全書き換え
- ドラッグ&ドロップイベント処理を実装
- 複数選択状態管理
- キーボードイベント処理（Delete, Ctrl+A, Ctrl+D, Esc）

**ThumbnailWidget**
- ドラッグ可能なウィジェットとして実装
- QDrag & QMimeData を使用
- ドラッグ時のプレビュー画像表示

**新規ファイル**
- `src/views/preview_dialog.py`: 画像拡大表示ダイアログ
- `src/views/progress_dialog.py`: プログレスバーダイアログ

#### 現在の動作状況

✅ **完全動作**
- ドラッグ&ドロップ並べ替え
- 複数選択（Ctrl, Shift）
- 画像削除（Delete, Space）
- 画像拡大表示
- ズーム機能
- プログレスバー（UI実装完了）

⚠️ **未実装**
- 新規フォルダ作成モード（UIは準備済み）
- スプラッシュスクリーン
- 非同期保存処理（プログレスバー表示）

### 2025-10-06 (2): アニメーション機能をMP4対応に変更

#### 変更内容

**背景**: 当初はPNG連番フレームでアニメーション再生を想定していたが、MP4動画でのループ再生に変更

**変更点**:
1. **animations.csv のフォーマット変更**
   - 変更前: `frame_count`, `fps`, `frame_prefix` (PNG連番用)
   - 変更後: `video_path` (MP4ファイルパス)
   - `loop` フラグは維持

2. **AnimationPlayer の完全書き換え**
   - PNG連番読み込み → MP4動画再生に変更
   - `QMediaPlayer` + `QVideoWidget` を使用
   - ループ再生機能実装
   - 音声はミュート設定

3. **依存関係の追加**
   - `PyQt6-Multimedia==6.6.1` を requirements.txt に追加

**使い方**:
```csv
animation_id,name,video_path,loop,description
idle,待機中,animations/idle.mp4,true,画像未読み込み時のアニメーション
```

**必要なファイル**:
- `animations/splash.mp4` - 起動時アニメーション
- `animations/idle.mp4` - 待機中アニメーション（ループ）

### 2025-10-06 (1): 初期実装完了

#### 実装内容

1. **プロジェクト構造の構築**
   - MVCアーキテクチャに基づいたディレクトリ構造
   - models/、controllers/、views/、utils/ の分離

2. **モデル層 (Models)**
   - `ImageModel`: 画像データ管理、サムネイル生成
   - `ConfigModel`: 設定の永続化（JSON）
   - `HistoryModel`: Undo/Redo履歴管理（最大50段階）

3. **コントローラー層 (Controllers)**
   - `ImageController`: 画像読み込み、並べ替え、削除、ソート
   - `RenameController`: ファイル名生成、検証、サンプル表示
   - `FileController`: ファイル保存、フォルダ作成、PNG→JPG変換

4. **ビュー層 (Views)**
   - `MainWindow`: メインウィンドウ、メニューバー、ショートカット
   - `SettingsPanel`: 設定パネル（モード選択、リネーム設定、JPG変換）
   - `PreviewArea`: 画像プレビューエリア、サムネイルグリッド表示

5. **ユーティリティ (Utils)**
   - `constants.py`: アプリケーション定数
   - `logger.py`: ログ管理（ローテーション機能付き）
   - `validator.py`: ファイル名検証、不正文字チェック
   - `animation.py`: アニメーション再生機能

6. **その他**
   - `main.py`: アプリケーションエントリーポイント
   - `requirements.txt`: 依存関係定義
   - `README.md`: ユーザーマニュアル
   - `.gitignore`: Git除外設定
   - `animations/animations.csv`: アニメーション定義

#### 実装済み機能

✅ **基本機能**
- フォルダから画像読み込み（.jpg, .jpeg, .png）
- サムネイル表示（グリッドレイアウト）
- サムネイルサイズ調整（100px〜400px）
- ファイル名順ソート（昇順/降順）
- 元の順序に戻す機能

✅ **リネーム機能**
- 連番のみ: `001.jpg`, `002.jpg`
- テキスト + 連番: `MyImage_001.jpg`
- 日付 + 連番: `251006_001.jpg` (YYMMDD形式)
- リアルタイムサンプル表示
- ファイル名検証（不正文字、予約語チェック）

✅ **編集機能**
- Undo/Redo（最大50段階）
- 削除機能（複数選択対応）
- 画像クリックイベント

✅ **保存機能**
- リネーム保存
- PNG → JPG変換（品質調整可能）
- 保存確認ダイアログ
- エラーハンドリング

✅ **設定管理**
- config.jsonで設定永続化
- ウィンドウサイズ・位置の記憶
- 前回のフォルダパス復元
- リネーム設定の保存

✅ **ログ機能**
- 起動・終了ログ
- 処理内容の記録
- エラーログ（スタックトレース付き）
- ログローテーション（最新30件保持）

✅ **UI/UX**
- メニューバー（ファイル、編集、ヘルプ）
- キーボードショートカット
- レスポンシブレイアウト
- スタイルシート適用

#### 未実装・簡略化した機能

⚠️ **ダイアログ**
- PreviewDialog（画像拡大表示）: 未実装
- ProgressDialog（保存進捗表示）: 未実装
- SplashScreen（起動画面）: 未実装

⚠️ **高度な機能**
- ドラッグ&ドロップによる並べ替え: 基本クリックのみ実装
- 複数選択（Ctrl+クリック、範囲選択）: 未実装
- 新規フォルダ作成モード: UI準備済みだが未完成
- アニメーション表示: フレーム画像が必要

⚠️ **その他**
- 非同期画像読み込み（QThread）: 未実装
- プログレスバー付き保存: 基本保存のみ実装

## プロジェクト構造

```
SortSnap/
├── main.py                       # メインエントリーポイント
├── requirements.txt              # 依存関係
├── README.md                     # ユーザーマニュアル
├── DEVELOPMENT.md                # 開発経過記録（本ファイル）
├── .gitignore                   # Git除外設定
│
├── src/
│   ├── __init__.py
│   │
│   ├── models/                  # データモデル層
│   │   ├── __init__.py
│   │   ├── image_model.py       # 画像データ管理
│   │   ├── config_model.py      # 設定管理
│   │   └── history_model.py     # Undo/Redo履歴
│   │
│   ├── controllers/             # ビジネスロジック層
│   │   ├── __init__.py
│   │   ├── image_controller.py  # 画像操作
│   │   ├── rename_controller.py # リネーム処理
│   │   └── file_controller.py   # ファイル操作
│   │
│   ├── views/                   # UI層
│   │   ├── __init__.py
│   │   ├── main_window.py       # メインウィンドウ
│   │   ├── settings_panel.py    # 設定パネル
│   │   └── preview_area.py      # プレビューエリア
│   │
│   ├── utils/                   # ユーティリティ
│   │   ├── __init__.py
│   │   ├── constants.py         # 定数定義
│   │   ├── logger.py            # ログ管理
│   │   ├── validator.py         # ファイル名検証
│   │   └── animation.py         # アニメーション再生
│   │
│   └── resources/               # リソース
│       ├── icons/               # アイコン（未実装）
│       └── styles/              # スタイルシート（未実装）
│
├── animations/                  # アニメーション
│   ├── animations.csv           # アニメーション定義
│   └── frames/                  # フレーム画像格納用
│       ├── splash_001.png 〜 030 (未作成)
│       └── idle_001.png 〜 060 (未作成)
│
└── logs/                        # ログフォルダ（実行時生成）
    └── sortsnap_log_*.txt
```

## セットアップ手順

### 1. 仮想環境の作成

```bash
python -m venv venv
```

### 2. 仮想環境のアクティベート

**Windows:**
```bash
venv\Scripts\activate
```

**macOS/Linux:**
```bash
source venv/bin/activate
```

### 3. 依存関係のインストール

```bash
pip install -r requirements.txt
```

### 4. アプリケーションの起動

```bash
python main.py
```

## 次の開発ステップ

### Phase 2: 基本機能の完成

1. **ドラッグ&ドロップ実装**
   - サムネイルのドラッグ開始検出
   - ドロップ位置の視覚的フィードバック
   - 画像順序の入れ替え処理

2. **複数選択機能**
   - Ctrl+クリックで個別選択
   - Shift+クリックで範囲選択
   - 選択状態の視覚的表示

3. **ダイアログ実装**
   - PreviewDialog: 画像拡大表示、ズーム、前後移動
   - ProgressDialog: 保存進捗、残り時間表示、キャンセル機能
   - SplashScreen: 起動時のアニメーション

### Phase 3: 高度な機能

1. **新規フォルダ作成モード**
   - ファイルドラッグ&ドロップ受付
   - 新規フォルダ作成処理
   - 重複チェック

2. **非同期処理**
   - QThreadによる画像読み込み
   - プログレスバー表示
   - UI応答性の向上

3. **アニメーション**
   - フレーム画像の作成
   - スプラッシュスクリーン実装
   - 待機中アニメーション

### Phase 4: 最適化・仕上げ

1. **パフォーマンス最適化**
   - サムネイルキャッシュ
   - メモリ管理
   - 大量画像対応（1,000枚以上）

2. **テスト**
   - ユニットテスト作成
   - 統合テスト
   - 実機テスト（Windows/macOS）

3. **ビルド・配布**
   - PyInstallerで実行ファイル作成
   - アイコン設定
   - インストーラー作成（オプション）

## 既知の問題

1. **アニメーション**: フレーム画像が未作成のため、アニメーション機能は動作しない
2. **ドラッグ&ドロップ**: クリック選択のみ、並べ替えは未実装
3. **プレビュー**: 拡大表示ダイアログが未実装
4. **保存進捗**: プログレスバーなし、同期処理のみ

## 技術的な決定事項

### アーキテクチャ
- **MVCパターン**: モデル・ビュー・コントローラーの明確な分離
- **シグナル/スロット**: PyQt6のシグナル機構を活用した疎結合設計

### データ永続化
- **config.json**: 設定の保存形式
- **履歴管理**: メモリ内でのUndoスタック（最大50段階）

### 画像処理
- **Pillow**: サムネイル生成、PNG→JPG変換
- **PyQt6 QPixmap**: UI表示用

### ログ
- **標準logging**: Pythonの標準ライブラリ使用
- **ローテーション**: 最新30件のログファイルを保持

---

### 2025-10-07 (8): 複数選択ドラッグ&ドロップ機能（Phase 7）

#### 実装内容

**複数選択した画像を一括でドラッグ&ドロップ移動できる機能**

1. **ImageControllerに複数画像移動メソッド追加**
   - `reorder_multiple(indices: list[int], to_index: int)` メソッド実装
   - 選択された複数画像を維持したまま一括移動
   - インデックス調整ロジック（削除前のインデックスから移動後の位置を計算）
   - Undo/Redo対応
   - `src/controllers/image_controller.py:143-184, 320-338`

2. **PreviewAreaでの複数選択検出と送信**
   - `order_changed_multiple` シグナル追加 (`list[int], int`)
   - `ThumbnailWidget`: MIMEデータにカンマ区切りでインデックス送信 (例: "0,2,5")
   - `dropEvent()`: カンマ検出で複数選択処理に分岐
   - `src/views/preview_area.py:18, 320, 520-593`

3. **MainWindow で複数選択時の分岐処理**
   - `_on_order_changed_multiple()` ハンドラ追加
   - シグナル接続: `order_changed_multiple.connect()`
   - `src/views/main_window.py:59, 294-298`

4. **遅延バインディング方式でpreview_area参照を設定**
   - **問題**: `ThumbnailWidget.__init__()` に `preview_area` 引数を追加したが、サムネイルサイズ変更時に既存ウィジェットが再利用されるため参照が `None` のままだった
   - **解決**: `set_preview_area()` メソッドを追加し、ウィジェット作成後および再利用時に明示的に参照を注入
   - 防御的プログラミング: `preview_area` 未設定時は単一ドラッグにフォールバック
   - `src/views/preview_area.py:478-480, 124, 203`

5. **ImageModel.selected との同期**
   - **問題**: `PreviewArea` は `self.selected_indices` で管理、`ThumbnailWidget.mouseMoveEvent()` は `ImageModel.selected` を参照していたため同期ズレが発生
   - **解決**: `_on_thumbnail_clicked()` および `_on_drag_started()` で `ImageModel.selected` を同期更新
   - Ctrl+クリック、Shift+クリック両対応
   - `src/views/preview_area.py:254-262, 277-284`

#### 技術的解決策

**遅延バインディングパターン**:
- ウィジェットの再利用によるライフサイクル問題を解決
- 参照を後から注入可能にすることで柔軟性を確保
- Gemini CLI との協業で選択した設計アプローチ

**データ同期パターン**:
- UI状態（`PreviewArea.selected_indices`）とモデル状態（`ImageModel.selected`）を明示的に同期
- 単一の真実の源（Source of Truth）を維持

#### 動作確認

- Ctrl+クリック: 複数選択（トグル）→ ドラッグ&ドロップ → 全画像一括移動 ✅
- Shift+クリック: 範囲選択 → ドラッグ&ドロップ → 全画像一括移動 ✅
- Undo/Redo: 複数画像移動の取り消し・やり直し ✅
- 単一選択: 既存動作と同じ（影響なし） ✅

---

## 参考資料

- 要件定義書: `SortSnap_要件定義書_v2.0.md`
- 技術要件定義書: `SortSnap_技術要件定義書_v1.0.md`
- PyQt6ドキュメント: https://www.riverbankcomputing.com/static/Docs/PyQt6/
- Pillowドキュメント: https://pillow.readthedocs.io/

## 開発者メモ

### 重要なファイル
- `src/controllers/image_controller.py`: 画像操作の中心的なロジック
- `src/views/main_window.py`: アプリケーションのメインエントリ
- `src/models/config_model.py`: 設定の永続化機構

### カスタマイズポイント
- `src/utils/constants.py`: デフォルト値の変更
- `src/views/settings_panel.py`: UI設定項目の追加
- `src/controllers/rename_controller.py`: リネームテンプレートの追加

## 連絡先・引き継ぎ事項

このプロジェクトを引き継ぐ場合:

1. **DEVELOPMENT.md（本ファイル）を確認**: 開発経過と現状把握
2. **要件定義書を確認**: 実装すべき機能の全体像把握
3. **README.mdを確認**: ユーザー視点での機能確認
4. **次の開発ステップを参照**: 未実装機能の優先順位確認

### 現時点での動作状況
- ✅ アプリケーション起動可能
- ✅ フォルダから画像読み込み可能
- ✅ サムネイル表示可能
- ✅ リネーム設定変更可能
- ✅ 保存機能動作（基本機能）
- ⚠️ 並べ替えは未実装（クリック選択のみ）
- ⚠️ アニメーションは画像未作成で非表示

---

**最終更新**: 2025-10-06
**ステータス**: Phase 1完了、Phase 2開始準備完了
