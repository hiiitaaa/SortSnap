SortSnap_要件定義書_v2.0.md
markdown# SortSnap 要件定義書（最終版）

**バージョン**: 2.0  
**作成日**: 2025年10月6日  
**最終更新**: 2025年10月6日

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [機能要件](#2-機能要件)
3. [非機能要件](#3-非機能要件)
4. [UI仕様](#4-ui仕様)
5. [システム要件](#5-システム要件)
6. [エラーハンドリング](#6-エラーハンドリング)
7. [制約事項](#7-制約事項)
8. [テスト要件](#8-テスト要件)
9. [リリース要件](#9-リリース要件)
10. [将来的な拡張](#10-将来的な拡張)
11. [起動時の初期化処理](#11-起動時の初期化処理)

---

## 1. プロジェクト概要

### 1.1 プロジェクト名
**SortSnap**

### 1.2 目的
画像ファイルを視覚的に並べ替え、統一された命名規則で一括リネーム・保存するクロスプラットフォーム対応のGUIツール。

### 1.3 対象ユーザー
- 開発者本人
- 他者への配布を想定（技術知識のないユーザーも含む）

### 1.4 配布形式
- **Windows**: `.exe`（単一実行ファイル）
- **macOS**: `.app`（アプリケーションバンドル）

### 1.5 開発フェーズ
**Phase 1（本要件定義の範囲）**:
- 基本的な並べ替え・リネーム機能
- 2つの動作モード
- JPG変換機能
- アニメーション機能
- 完全なエラーハンドリング

---

## 2. 機能要件

### 2.1 動作モード

#### 2.1.1 フォルダモード（デフォルト）
**概要**: 既存フォルダ内の画像ファイルを読み込み、並べ替え・リネームして保存。

**フロー**:
1. ユーザーがフォルダを選択（Ctrl+O または メニュー）
2. フォルダ内の対応画像（.jpg, .jpeg, .png）を自動検出
3. 画像をサムネイル表示
4. ドラッグ&ドロップで順序変更
5. リネーム設定
6. 保存ボタン押下でリネーム・保存

**制約**:
- サブフォルダ内の画像は読み込まない
- 対応形式以外は無視

#### 2.1.2 新規フォルダ作成モード
**概要**: 複数の画像ファイルをGUIに直接ドラッグ&ドロップし、新規フォルダを作成してリネーム保存。

**フロー**:
1. 画像ファイルを直接GUIにドラッグ&ドロップ
2. サムネイル表示
3. ドラッグ&ドロップで順序変更
4. リネーム設定
5. 出力先フォルダと新規フォルダ名を指定
6. 保存ボタン押下で新規フォルダ作成・リネーム保存

---

### 2.2 画像表示・操作機能

#### 2.2.1 サムネイル表示
- **デフォルトサイズ**: 200x200ピクセル
- **アスペクト比**: 維持
- **レイアウト**: グリッド形式
- **スクロール**: 縦スクロールバー対応（大量画像対応）

#### 2.2.2 選択機能
**選択方法**:
- **Ctrl + クリック**: 個別追加選択
- **Shift + クリック**: 範囲選択
- **Ctrl + A**: 全選択
- **範囲ドラッグ**: マウスで四角形を描いて範囲選択

**視覚的フィードバック**:
- **選択状態**: 青い太枠線
- **選択数表示**: 「3枚選択中」
- **範囲ドラッグ中**: 半透明の青い四角形

**選択解除**:
- 空白クリック
- Ctrl + D
- Esc

#### 2.2.3 並べ替え操作
**ドラッグ&ドロップ**:
- マウスでサムネイルをドラッグして順序変更
- 複数選択時はまとめて移動可能
- ドロップ位置: 画像と画像の間（青い縦線表示）
- ドラッグ中のビジュアルフィードバック

**ドラッグ中のスクロール追従**:
- **トリガーゾーン**: ウィンドウ上端・下端から50px以内
- **スクロール速度**: 段階的変化
  - 0-20px: 速い（20px/フレーム）
  - 20-40px: 普通（10px/フレーム）
  - 40-50px: 遅い（5px/フレーム）
- **視覚的フィードバック**: なし
- **方向**: 縦スクロールのみ

#### 2.2.4 サムネイルサイズ変更
**キーボード操作**:
- `Ctrl + +` / `Cmd + +`: 拡大
- `Ctrl + -` / `Cmd + -`: 縮小
- `Ctrl + 0` / `Cmd + 0`: リセット（200x200）

**GUIボタン**: 画像プレビューエリア下部
- `[+]`: 拡大
- `[-]`: 縮小
- `[リセット]`: デフォルトサイズ

**サイズ範囲**:
- 最小: 100x100px
- 最大: 400x400px
- ステップ: 50px

#### 2.2.5 ソート機能
**ソート種類**:
- ファイル名（昇順）
- ファイル名（降順）
- 元の順序に戻す

**UI配置**:
- 画像プレビューエリア下部: `[名前▲] [名前▼] [元の順序]`
- メニューバー: 編集(E) → ソート

**動作**:
- アニメーションなし（瞬時に並び替え）
- Undo対応
- 全体をソート（選択状態に関わらず）
- 自然順ソート（image2.jpg → image10.jpg）
- 大文字小文字区別なし

#### 2.2.6 画像削除機能
**操作**:
- **Space / Delete**: 選択画像を削除
- **複数選択時**: 選択された全画像を削除

**Undo/Redo**:
- **Ctrl + Z** / **Cmd + Z**: 元に戻す
- **Ctrl + Shift + Z** / **Cmd + Shift + Z**: やり直し
- **履歴段階数**: 50段階
- **対象操作**: 削除、並べ替え、ソート
- **履歴クリア**: 保存完了時、フォルダ読み込み時

---

### 2.3 プレビュー拡大表示

#### 2.3.1 起動方法
- サムネイルをクリック
- Enter キー（選択画像）

#### 2.3.2 表示方法
- **オーバーレイ**: フルスクリーン風の半透明黒背景
- **画像表示**: ウィンドウサイズに合わせる（アスペクト比維持）

#### 2.3.3 ズーム機能
- **マウスホイール**: 上（拡大）/ 下（縮小）
- **ボタン**: `[+]` `[-]` `[100%]` `[ウィンドウに合わせる]`
- **ダブルクリック**: 100%とウィンドウサイズを切り替え
- **範囲**: 最小（ウィンドウに収まるサイズ）〜 最大100%

#### 2.3.4 表示情報
- ファイル名
- 画像解像度
- ファイルサイズ
- リネーム後のファイル名
- 画像番号（例: 1 / 1234）

#### 2.3.5 前後の画像への移動
- **右矢印 / →**: 次の画像
- **左矢印 / ←**: 前の画像
- **ループしない**: 端で停止
- **矢印ボタン**: `[<]` `[>]` ホバー時のみ表示

#### 2.3.6 拡大表示中の削除
- **Space / Delete**: 確認なしで削除 → 次の画像を自動表示
- **最後の画像**: 拡大表示を閉じる
- **Ctrl + Z**: 削除を元に戻す（拡大表示は維持）

#### 2.3.7 閉じる方法
- Esc キー
- 半透明背景をクリック
- × ボタン（右上）
- 拡大画像をクリック

---

### 2.4 リネーム機能

#### 2.4.1 命名規則テンプレート
**ドロップダウンリストで選択**:
1. **連番のみ**: `001.jpg`, `002.jpg`...
2. **テキスト + 連番**: `MyImage_001.jpg`...
3. **日付 + 連番**: `251006_001.jpg`...（YYMMDD形式）

#### 2.4.2 設定項目
**共通設定**:
- 連番開始番号（デフォルト: 1、範囲: 0〜9999）
- 連番桁数（デフォルト: 3、範囲: 1〜6）

**テキスト + 連番モード**:
- プレフィックス入力欄

**日付 + 連番モード**:
- 日付形式: YYMMDD（今日の日付を自動取得）

#### 2.4.3 リネーム後サンプル表示
- 設定パネル内、3行表示
- リアルタイム更新
- 読み取り専用、薄いグレー背景

#### 2.4.4 リネーム処理
- GUI上の**表示順序**が新しい連番になる
- 元のファイル名は無関係

---

### 2.5 ファイル名の検証

#### 2.5.1 不正文字チェック
**両OS共通で禁止**: `< > : " / \ | ? *`

**予約語チェック（Windows）**:
CON, PRN, AUX, NUL, COM1-9, LPT1-9

**その他の制限**:
- ファイル名: 最大255文字
- パス全体: 最大260文字
- 末尾のスペース・ピリオド: 削除

#### 2.5.2 チェックタイミング
- **リアルタイム**: 入力中に検出、赤枠 + 警告表示
- **保存時**: 最終チェック、置換提案ダイアログ

#### 2.5.3 置換ルール
- 不正文字 → `_`
- 末尾スペース・ピリオド → 削除
- 連続アンダースコア → そのまま

---

### 2.6 JPG変換機能

#### 2.6.1 変換オプション
- **チェックボックス**: 「JPGに変換」（デフォルト: オフ）
- **対象**: PNG形式のみ

#### 2.6.2 品質設定
- **スライダー + 数値入力**: 0〜100%
- **デフォルト**: 95
- **表示**: 常に表示、チェックOFF時はグレーアウト

#### 2.6.3 変換処理
- PNG → JPG変換
- 拡張子を `.jpg` に変更
- 透過情報は白背景に合成
- 変換失敗時: PNG形式で保存を試みる

#### 2.6.4 EXIF情報
- **保持しない**: 処理を簡素化、高速化優先

---

### 2.7 出力先設定

#### 2.7.1 フォルダモード
- **デフォルト**: 読み込み元フォルダ
- **変更可能**: 参照ボタンでフォルダ選択
- **上書き動作**: 同名ファイルは確認なしで上書き

#### 2.7.2 新規フォルダ作成モード
- **親ディレクトリ**: 参照ボタンで選択
- **新規フォルダ名**: テキスト入力欄
  - デフォルト: 今日の日付（YYMMDD）
  - 編集可能
- **フォルダ作成**: 保存時に自動作成
- **重複時**: エラー表示、再入力を促す（自動連番なし）

---

### 2.8 保存確認ダイアログ

#### 2.8.1 表示設定
- **設定で選択可能**: 「保存時に確認する」チェックボックス
- **デフォルト**: 有効

#### 2.8.2 表示内容
**必須情報**:
- モード
- 処理枚数
- 出力先パス
- リネーム形式サンプル
- JPG変換（あり/なし、品質）

**警告メッセージ**:
- 上書き保存時
- 大量処理時
- JPG変換時
- 新規フォルダ作成時

#### 2.8.3 UI
- **モーダルウィンドウ**: 他の操作をブロック
- **背景オーバーレイ**: 半透明の暗い背景
- **ボタン配置**: `[キャンセル] [保存実行]`
- **キーボード**: Enter（保存）/ Esc（キャンセル）
- **「今後表示しない」**: グローバル設定

---

### 2.9 プログレスバー + キャンセル機能

#### 2.9.1 表示
- **タイミング**: 常に表示（処理枚数に関わらず）
- **形式**: モーダルダイアログ

#### 2.9.2 表示情報
- 進捗率（%）
- プログレスバー
- 処理枚数（現在/全体）
- 経過時間
- 残り時間（約XX:XX、直近速度から算出）
- 現在処理中のファイル名

#### 2.9.3 更新
- **更新頻度**: 100msごと

#### 2.9.4 キャンセル機能
**確認ダイアログ**:
- キャンセルボタン押下時に表示
- 処理済み枚数を表示
- 保存済みファイルはそのまま残す旨を通知

**キャンセル後**:
- 保存済みファイルは残す
- 通知ダイアログで結果を表示
- ログに記録

#### 2.9.5 エラー発生時
- エラーをログに記録
- 処理は継続（次のファイルへ）
- 完了後にエラーサマリー表示

#### 2.9.6 完了時
- **成功時**: 1秒後に自動で閉じる
- **エラーあり**: エラーサマリーダイアログ（手動で閉じる）

---

### 2.10 ログ機能

#### 2.10.1 ログレベル
- **INFO**: 正常な処理
- **WARNING**: 警告（処理継続）
- **ERROR**: エラー（一部失敗）

#### 2.10.2 ログファイル
- **ファイル名**: `sortsnap_log_YYMMDD_HHMMSS.txt`
- **保存場所**: `logs/` フォルダ
- **ローテーション**: 最新30件まで保持
- **形式**: プレーンテキスト

#### 2.10.3 記録内容
- アプリケーション起動・終了
- フォルダ読み込み
- 保存処理（詳細設定含む）
- エラー詳細（スタックトレース含む）
- 保存キャンセル
- 処理時間

#### 2.10.4 アクセス方法
- **メニューバー**: ヘルプ(H) → ログフォルダを開く
- **エラー時**: エラーダイアログに「ログを確認」ボタン

---

### 2.11 設定の永続化

#### 2.11.1 保存する設定
- モード選択
- 入力元・出力先フォルダパス
- リネームテンプレート選択
- プレフィックステキスト
- 連番開始番号・桁数
- JPG変換チェック状態・品質
- サムネイルサイズ
- ウィンドウサイズ・位置
- 保存確認ダイアログ表示設定
- アニメーション有効/無効

#### 2.11.2 設定ファイル
- **ファイル名**: `config.json`
- **保存場所**: 実行ファイルと同じディレクトリ
- **形式**: JSON
- **自動生成**: 初回起動時

#### 2.11.3 保存・読み込み
- **保存**: 設定変更時に即座に保存
- **読み込み**: 起動時に自動読み込み

---

### 2.12 アニメーション機能

#### 2.12.1 ファイル構造
SortSnap/
└── animations/
├── animations.csv
└── frames/
├── splash_001.png 〜 splash_030.png
└── idle_001.png 〜 idle_060.png

#### 2.12.2 animations.csv
```csv
animation_id,name,frame_count,fps,loop,frame_prefix,description
splash,スプラッシュ,30,30,false,splash_,起動時のアニメーション
idle,待機中,60,24,true,idle_,画像未読み込み時のアニメーション
2.12.3 表示場所
スプラッシュスクリーン:

splash アニメーション
30フレーム、30fps、ループなし
サイズ: 200x200px

画像プレビューエリア（空の状態）:

idle アニメーション
60フレーム、24fps、ループあり
サイズ: 150x150px
位置: 中央

2.12.4 無効化

config.json の enable_animations で制御
デフォルト: 有効

2.12.5 デフォルトアニメーション

サンプルアニメーションを同梱
ユーザーがカスタマイズ可能


2.13 キーボードショートカット
画像選択
ショートカット機能Ctrl/Cmd + A全選択Ctrl/Cmd + D選択解除Esc選択解除↑↓←→画像選択移動Shift + ↑↓←→選択範囲拡張
画像操作
ショートカット機能Space / Delete選択画像を削除Ctrl/Cmd + Z元に戻す（Undo）Ctrl/Cmd + Shift + Zやり直し（Redo）
サムネイル表示
ショートカット機能Ctrl/Cmd + +サムネイル拡大Ctrl/Cmd + -サムネイル縮小Ctrl/Cmd + 0サムネイルサイズリセット
プレビュー拡大表示
ショートカット機能Enter選択画像を拡大表示Esc拡大表示を閉じる← →前後の画像へSpace / Delete拡大表示中に削除マウスホイールズームイン/アウト
ファイル・保存操作
ショートカット機能Ctrl/Cmd + Oフォルダを開くCtrl/Cmd + S保存実行

2.14 メニューバー
ファイル(F)
├─ フォルダを開く (Ctrl+O)
├─ ───────────────
├─ 保存 (Ctrl+S)
├─ ───────────────
└─ 終了 (Alt+F4)
編集(E)
├─ 元に戻す (Ctrl+Z)
├─ やり直し (Ctrl+Shift+Z)
├─ ───────────────
├─ 全選択 (Ctrl+A)
├─ 選択解除 (Ctrl+D)
├─ ───────────────
├─ 選択画像を削除 (Delete)
├─ ───────────────
├─ ソート
│   ├─ ファイル名（昇順）
│   ├─ ファイル名（降順）
│   └─ 元の順序に戻す
表示(V)
├─ サムネイル拡大 (Ctrl++)
├─ サムネイル縮小 (Ctrl+-)
├─ サムネイルサイズリセット (Ctrl+0)
├─ ───────────────
└─ プレビュー表示 (Enter)
ヘルプ(H)
├─ 使い方 (F1)
├─ ───────────────
├─ ログフォルダを開く
├─ ───────────────
└─ バージョン情報

3. 非機能要件
3.1 パフォーマンス
3.1.1 想定処理枚数

通常想定: 1,000枚
最大: 1,000枚以上も可能

3.1.2 パフォーマンス目標

起動時間: 3秒以内
1,000枚読み込み: 10秒以内
UI操作: レスポンシブ

3.1.3 メモリ使用量

サムネイルキャッシュ: 最大200MB程度
Undo/Redo履歴: 10〜100MB程度
アニメーション: 約11MB


3.2 ユーザビリティ
3.2.1 UIデザイン

ウィンドウサイズ: デフォルト 1920x1080
最小サイズ: 1280x720
リサイズ: 可変
レイアウト: 左右2分割

左側（4/5）: 画像プレビューエリア
右側（1/5）: 設定パネル



3.2.2 操作の直感性

ドラッグ&ドロップによる直感的な並べ替え
リアルタイムプレビュー
視覚的フィードバック


3.3 移植性・環境非依存性
3.3.1 クロスプラットフォーム対応

Windows: Windows 10/11（64bit）
macOS: macOS 11 Big Sur以降

3.3.2 ポータブル設計

レジストリ不使用
システムフォルダ不使用
実行ファイルと同じディレクトリに全設定を保存


4. UI仕様
4.1 メインウィンドウレイアウト
┌─────────────────────────────────────────────────────┐
│  ファイル(F)  編集(E)  表示(V)  ヘルプ(H)           │
├─────────────────────────────────┬───────────────────┤
│   【画像プレビューエリア】      │ 【設定パネル】    │
│                                 │                   │
│   ┌──────┐ ┌──────┐ ┌──────┐   │ モード選択        │
│   │[画像1]│ │[画像2]│ │[画像3]│   │ ◉ フォルダ       │
│   │ 001  │ │ 002  │ │ 003  │   │ ○ 新規フォルダ   │
│   └──────┘ └──────┘ └──────┘   │                   │
│                                 │ ─────────────     │
│   [スクロールバー]              │ リネーム設定      │
│                                 │ ▼ [テンプレ ▼]   │
│                                 │                   │
│  [+][-][リセット]|[名前▲][▼]   │ [💾 保存]         │
└─────────────────────────────────┴───────────────────┘
4.2 設定パネル詳細
セクション構成（上から順）:

モード選択（ラジオボタン、説明文付き）
リネーム設定（テンプレート、入力欄、サンプル）
JPG変換設定（チェックボックス、品質スライダー）
出力先設定（パス表示、参照ボタン、新規フォルダ名）
保存ボタン（大きめ、中央揃え、💾アイコン）

スタイル:

パディング: 16px
セクション間マージン: 24px
入力欄高さ: 32px
フォント: 12pt（通常）/ 9pt（説明文）
区切り線: 薄いグレー、1px


5. システム要件
5.1 開発環境

言語: Python 3.10以降
GUIフレームワーク: PyQt6 または PySide6
画像処理: Pillow
パッケージング: PyInstaller

最小構成ライブラリ:

PyQt6 / PySide6
Pillow
標準ライブラリ（json, os, pathlib, datetime）

除外:

numpy, pandas, matplotlib など重いライブラリは不使用

5.2 実行環境

Windows: Windows 10/11（64bit）
macOS: macOS 11以降
メモリ: 最低 4GB RAM（推奨 8GB以上）
ストレージ: 50MB以上の空き容量

5.3 対応ファイル形式

読み込み: .jpg, .jpeg, .png
保存: .jpg, .png


6. エラーハンドリング
6.1 エラー分類
レベル説明動作CRITICALアプリ継続不可即座に終了ERROR処理失敗エラー通知、処理中断WARNING警告、処理継続可警告通知、処理継続INFO情報通知ログ記録のみ
6.2 主なエラーケース
起動時:

設定ファイル破損 → デフォルト設定、ログのみ
ログフォルダ作成失敗 → ログ機能無効化、ログのみ

読み込み時:

フォルダアクセス権限エラー → エラーダイアログ、再選択
対応画像なし → 警告ダイアログ、再選択
画像読み込み失敗 → スキップ、ログのみ

保存時:

書き込み権限エラー → エラーダイアログ、処理中断
ディスク容量不足 → スキップ、エラーサマリー
個別ファイル保存失敗 → スキップ、エラーサマリー
PNG→JPG変換失敗 → PNG形式で保存

新規フォルダ作成時:

フォルダ名重複 → エラー表示、再入力
フォルダ作成失敗 → エラーダイアログ、処理中断

クリティカルエラー:

予期しないエラー → エラーダイアログ（ログを開くボタン付き）、終了

6.3 ログ記録

詳細ログ: スタックトレース含む
エラー詳細: ファイルパス、エラー内容、OS情報、Python情報


7. 制約事項
7.1 機能的制約

サブフォルダの再帰的読み込み非対応
動画ファイル、GIF、BMP等非対応
バッチ処理非対応
EXIF情報は保持しない

7.2 技術的制約

インターネット接続不要（オフライン動作）
外部依存ライブラリは最小限
実行ファイルサイズ: 50MB以下を目標


8. テスト要件
8.1 機能テスト

各モードの基本動作確認
リネーム機能の正確性検証
JPG変換機能の品質確認
大量画像（1,000枚）での動作確認
Undo/Redo機能の検証
キーボードショートカット動作確認

8.2 非機能テスト

パフォーマンステスト（読み込み速度、保存速度）
メモリ使用量測定
クロスプラットフォーム動作確認

8.3 エラーハンドリングテスト

権限エラー
ディスク容量不足
不正なファイル名
フォルダ名重複


9. リリース要件
9.1 配布物

Windows版: SortSnap.exe
macOS版: SortSnap.app
README.md: 使用方法の説明
サンプルアニメーション: 同梱

9.2 ドキュメント

ユーザーマニュアル（README.md内）
アニメーション作成ガイド
既知の問題・制限事項


10. 将来的な拡張（Phase 2以降）
10.1 検討中の機能

バッチ処理（複数フォルダ対応）
画像のフィルタリング
EXIF情報の表示・編集
その他のリネームルール
ダークモード


11. 起動時の初期化処理
11.1 起動シーケンス

アプリケーション起動
スプラッシュスクリーン表示（splash アニメーション）
ログシステム初期化
設定ファイル読み込み
UI初期化
前回の状態復元（パスのみ）
スプラッシュスクリーン非表示
メインウィンドウ表示（idle アニメーション）

11.2 設定復元

ウィンドウサイズ・位置
前回の入力・出力フォルダパス
全ての設定項目

11.3 初期状態

画像プレビューエリア: 空（idle アニメーション表示）
設定パネル: 前回の設定を復元